<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crear contraseña - ReporteYa</title>
  <script src="https://esm.sh/@supabase/supabase-js@2"></script>
  <style>
    :root { --primary:#1565C0; }
    body{font-family:system-ui,sans-serif;max-width:480px;margin:40px auto;padding:0 16px}
    input,button{padding:12px;margin:8px 0;font-size:16px}
    input{border:2px solid #90A4AE;border-radius:10px;background:#D6E4FF;width:100%}
    input:focus{border-color:#3B82F6}
    .row{display:flex;gap:8px;align-items:center}
    .row input{flex:1;min-width:0}
    .toggle{width:auto;padding:6px 10px;border-radius:10px;background:#90A4AE;color:#111;border:0}
    #btn{width:100%;border:0;border-radius:999px;background:var(--primary);color:#fff}
    .msg{min-height:24px;margin-top:8px}
    .hint{min-height:18px;color:#D32F2F;font-size:14px;margin-top:4px}
    .ok{color:#2E7D32}.err{color:#D32F2F}
  </style>
</head>
<body>
  <h1>Crear contraseña</h1>
  <p>Ingresa tu nueva contraseña para activar tu cuenta.</p>
  <div class="row">
    <input id="pass1" type="password" placeholder="Nueva contraseña" />
    <button type="button" id="toggle1" class="toggle">Mostrar</button>
  </div>
  <div class="row">
    <input id="pass2" type="password" placeholder="Repite la contraseña" />
    <button type="button" id="toggle2" class="toggle">Mostrar</button>
  </div>
  <div id="hint" class="hint"></div>
  <button id="btn">Guardar</button>
  <p id="msg" class="msg"></p>
  <script>
    const supabase = window.supabase.createClient(
      "https://uppdkjfjxtjnukftgwhz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwcGRramZqeHRqbnVrZnRnd2h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDE3NjMsImV4cCI6MjA2MzI3Nzc2M30._bPFFm4NqghiVPmytaGkiD40QFc1Ct-oIQx1gOK0g74"
    );

    const q = (s) => document.querySelector(s);
    const show = (t, ok=false) => { const m=q('#msg'); m.textContent=t; m.className='msg '+(ok?'ok':'err'); };

    function parseHash() {
      const h = new URLSearchParams(window.location.hash.slice(1));
      const access_token = h.get('access_token');
      const refresh_token = h.get('refresh_token');
      const error = h.get('error');
      const error_description = h.get('error_description');
      return { access_token, refresh_token, error, error_description };
    }

    async function ensureInviteSession() {
      const { access_token, refresh_token, error, error_description } = parseHash();
      if (error) { show(error_description || 'Enlace inválido o expirado. Solicita una nueva invitación.'); return false; }
      if (access_token && refresh_token) {
        const { error } = await supabase.auth.setSession({ access_token, refresh_token });
        if (error) console.warn('setSession error', error);
      }
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { show('No hay sesión de invitación activa. Abre el enlace del correo nuevamente.'); return false; }
      return true;
    }

    window.addEventListener('load', ensureInviteSession);

    function updateState(){
      const p1 = q('#pass1').value.trim();
      const p2 = q('#pass2').value.trim();
      const btn = q('#btn');
      const mismatch = p1 && p2 && p1 !== p2;
      q('#hint').textContent = mismatch ? 'Las contraseñas no coinciden.' : '';
      btn.disabled = mismatch;
    }
    q('#pass1').addEventListener('input', updateState);
    q('#pass2').addEventListener('input', updateState);
    q('#toggle1').onclick=()=>{ const i=q('#pass1'); i.type=i.type==='password'?'text':'password'; q('#toggle1').textContent=i.type==='password'?'Mostrar':'Ocultar'; };
    q('#toggle2').onclick=()=>{ const i=q('#pass2'); i.type=i.type==='password'?'text':'password'; q('#toggle2').textContent=i.type==='password'?'Mostrar':'Ocultar'; };

    q('#btn').onclick = async () => {
      if (!(await ensureInviteSession())) return;
      const p1 = q('#pass1').value.trim();
      const p2 = q('#pass2').value.trim();
      if (!p1 || !p2 || p1 !== p2) { q('#hint').textContent='Las contraseñas no coinciden.'; return; }
      if (p1.length < 8) { show('Usa al menos 8 caracteres.'); return; }
      const { error } = await supabase.auth.updateUser({ password: p1 });
      if (error) { show('No se pudo guardar: ' + (error.message || 'Intenta otra vez.')); return; }
      show('Contraseña creada. Ya puedes iniciar sesión en la app.', true);
    };
  </script>
</body>
</html>
