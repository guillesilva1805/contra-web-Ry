<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crear contraseña - ReporteYa</title>
  <script src="https://esm.sh/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:system-ui,sans-serif;max-width:480px;margin:40px auto}
    input,button{width:100%;padding:12px;margin:8px 0;font-size:16px}
    input{border:2px solid #90A4AE;border-radius:10px;background:#D6E4FF}
    input:focus{border-color:#3B82F6}
    button{border:0;border-radius:999px;background:#1565C0;color:#fff}
    .msg{min-height:24px;margin-top:8px}
    .ok{color:#2E7D32}.err{color:#D32F2F}
  </style>
</head>
<body>
  <h1>Crear contraseña</h1>
  <p>Ingresa tu nueva contraseña para activar tu cuenta.</p>
  <input id="pass1" type="password" placeholder="Nueva contraseña" />
  <input id="pass2" type="password" placeholder="Repite la contraseña" />
  <button id="btn">Guardar</button>
  <p id="msg" class="msg"></p>
  <script>
    const supabase = window.supabase.createClient(
      "https://uppdkjfjxtjnukftgwhz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwcGRramZqeHRqbnVrZnRnd2h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDE3NjMsImV4cCI6MjA2MzI3Nzc2M30._bPFFm4NqghiVPmytaGkiD40QFc1Ct-oIQx1gOK0g74"
    );

    const q = (s) => document.querySelector(s);
    const show = (t, ok=false) => { const m=q('#msg'); m.textContent=t; m.className='msg '+(ok?'ok':'err'); };

    function parseHash() {
      const h = new URLSearchParams(window.location.hash.slice(1));
      const access_token = h.get('access_token');
      const refresh_token = h.get('refresh_token');
      const error = h.get('error');
      const error_description = h.get('error_description');
      return { access_token, refresh_token, error, error_description };
    }

    async function ensureInviteSession() {
      const { access_token, refresh_token, error, error_description } = parseHash();
      if (error) {
        show(error_description || "Enlace inválido o expirado. Solicita una nueva invitación.");
        return false;
      }
      if (access_token && refresh_token) {
        const { error } = await supabase.auth.setSession({ access_token, refresh_token });
        if (error) console.warn('setSession error', error);
      }
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { show('No hay sesión de invitación activa. Abre el enlace del correo nuevamente.'); return false; }
      return true;
    }

    window.addEventListener('load', ensureInviteSession);

    function updateState(){
      const p1 = document.querySelector('#pass1').value.trim();
      const p2 = document.querySelector('#pass2').value.trim();
      const btn = document.querySelector('#btn');
      const mismatch = p1 && p2 && p1 !== p2;
      if(mismatch){ document.querySelector('#hint').textContent='Las contraseñas no coinciden.'; btn.disabled=true; }
      else { document.querySelector('#hint').textContent=''; document.querySelector('#msg').textContent=''; btn.disabled=false; }
    }
    document.querySelector('#pass1').addEventListener('input', updateState);
    document.querySelector('#pass2').addEventListener('input', updateState);
    document.querySelector('#toggle1').onclick=()=>{ const i=document.querySelector('#pass1'); i.type=i.type==='password'?'text':'password'; const b=document.querySelector('#toggle1'); b.textContent = i.type==='password'?'Mostrar':'Ocultar'; };
    document.querySelector('#toggle2').onclick=()=>{ const i=document.querySelector('#pass2'); i.type=i.type==='password'?'text':'password'; const b=document.querySelector('#toggle2'); b.textContent = i.type==='password'?'Mostrar':'Ocultar'; };


    q('#btn').onclick = async () => {
      if (!(await ensureInviteSession())) return;
      const p1 = q('#pass1').value.trim();
      const p2 = q('#pass2').value.trim();
      if (!p1 || !p2 || p1 !== p2) { document.querySelector('#hint').textContent='Las contraseñas no coinciden.'; return; }
      if (p1.length < 8) { show('Usa al menos 8 caracteres.'); return; }
      const { error } = await supabase.auth.updateUser({ password: p1 });
      if (error) { show('No se pudo guardar: ' + (error.message or 'Intenta otra vez.')); return; }
      show('Contraseña creada. Ya puedes iniciar sesión en la app.', true);
    };
  </script>
</body>
</html>
